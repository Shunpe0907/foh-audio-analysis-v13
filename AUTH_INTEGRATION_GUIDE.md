# PA Audio Analyzer - 認証システム統合ガイド

## 📋 概要

ユーザー認証と管理者ダッシュボードを実装しました。

### 主要機能

1. **ユーザー認証**
   - メールアドレス・パスワードでログイン
   - 新規ユーザー登録
   - パスワード変更
   - プロフィール管理

2. **ユーザー別データ管理**
   - 各ユーザーの解析履歴を個別管理
   - 過去データの閲覧・比較
   - データ削除機能

3. **管理者ダッシュボード**
   - 全ユーザーの一覧表示
   - アップロード音源の確認
   - システム統計
   - ユーザーアクティビティ監視

## 🚀 セットアップ手順

### ステップ1: ファイル配置

以下のファイルを同じディレクトリに配置：

```
pa-audio-analyzer/
├── pa_analyzer_v3_final.py          # メインアプリ
├── auth_system.py                    # 認証システム（新規）
├── pa_analyzer_with_auth.py         # 統合版（新規）
└── requirements.txt
```

### ステップ2: requirements.txt に追加

既存のrequirements.txtに以下は既に含まれています：
- streamlit
- その他のライブラリ

追加不要です。

### ステップ3: デフォルト管理者アカウント

初回起動時に自動作成されます：

```
メールアドレス: admin@pa-analyzer.local
パスワード: admin123
```

**⚠️ 重要: 初回ログイン後、必ずパスワードを変更してください**

### ステップ4: 起動

```bash
streamlit run pa_analyzer_with_auth.py
```

## 📊 データベース構造

### users.json（ユーザーデータベース）

```json
{
  "user@example.com": {
    "email": "user@example.com",
    "password_hash": "salt:hash",
    "name": "山田太郎",
    "role": "user",  // "user" または "admin"
    "created_at": "2024-01-01T00:00:00",
    "last_login": "2024-01-02T12:00:00",
    "profile": {
      "organization": "フリーランス",
      "location": "東京",
      "bio": "自己紹介..."
    },
    "stats": {
      "total_analyses": 10,
      "last_analysis_date": "2024-01-02T10:00:00"
    }
  }
}
```

### user_audio_data/（ユーザー別音源データ）

```
user_audio_data/
├── user_at_example_com.json
├── admin_at_pa-analyzer_local.json
└── ...
```

各ファイルの内容：

```json
{
  "analyses": [
    {
      "id": "20240101_120000",
      "timestamp": "2024-01-01T12:00:00",
      "metadata": {
        "analysis_name": "ライブ本番",
        "venue": "CLUB QUATTRO",
        "venue_capacity": 150,
        "mixer": "Yamaha CL5",
        "pa_system": "d&b V-Series",
        "band_lineup": "ボーカル、キック、スネア、ベース、ギター",
        "notes": "メモ..."
      },
      "analysis": {
        "rms_db": -18.2,
        "peak_db": -3.1,
        "stereo_width": 65.3,
        "crest_factor": 12.3,
        "band_energies": [...],
        "instruments": {...}
      }
    }
  ]
}
```

## 🎯 使い方

### 一般ユーザー

1. **新規登録**
   - メールアドレス、パスワード、名前を入力
   - プロフィール情報（任意）

2. **ログイン**
   - 登録したメールアドレスとパスワード

3. **解析実行**
   - 通常通り音源をアップロード
   - 解析データは自動的にユーザーアカウントに紐付け

4. **過去データ閲覧**
   - 「過去データ」タブで自分の解析履歴を確認
   - 比較・削除が可能

5. **プロフィール管理**
   - サイドバーの「プロフィール」から編集

### 管理者

1. **ログイン**
   - デフォルト管理者アカウントでログイン
   - パスワード変更推奨

2. **管理者ダッシュボード**
   - サイドバーに「管理者ダッシュボード」が表示
   
3. **機能**
   - **統計**: システム全体の利用状況
   - **ユーザー管理**: 全ユーザーの詳細確認
   - **音源管理**: アップロードされた全音源の確認

## 🔒 セキュリティ

### パスワード保護

- SHA-256 + Salt でハッシュ化
- 平文パスワードは保存されません

### セッション管理

- Streamlitのセッションステートで管理
- ページリロードでセッション維持

### データ分離

- ユーザー別にデータファイルを分離
- 他のユーザーのデータにアクセス不可

## 🎨 UI構成

### ログイン前

```
🔐 ログイン
├── メールアドレス
├── パスワード
├── [ログイン]
└── [新規登録]
```

### ログイン後（一般ユーザー）

```
サイドバー:
├── 👤 ようこそ、〇〇さん
├── 📊 プロフィール
├── 🚪 ログアウト

メインエリア:
├── タブ1: 🎵 新規解析
├── タブ2: 📊 過去データ
```

### ログイン後（管理者）

```
サイドバー:
├── 🛡️ 管理者: 〇〇さん
├── 📊 プロフィール
├── 🛡️ 管理者ダッシュボード
├── 🚪 ログアウト

管理者ダッシュボード:
├── タブ1: 📊 統計
│   ├── 総ユーザー数
│   ├── 総解析数
│   ├── アクティブユーザー
│   └── 最近のアクティビティ
├── タブ2: 👥 ユーザー管理
│   ├── 検索・フィルター
│   └── ユーザー詳細一覧
└── タブ3: 🎵 音源管理
    ├── 検索・フィルター
    └── 音源詳細一覧
```

## 🔧 カスタマイズ

### 管理者アカウント追加

`auth_system.py` の `create_default_admin()` を編集するか、
既存の管理者が users.json を直接編集：

```json
{
  "newadmin@example.com": {
    "email": "newadmin@example.com",
    "password_hash": "...",
    "name": "新しい管理者",
    "role": "admin",  // ← これを "admin" に設定
    ...
  }
}
```

### パスワードポリシー変更

`auth_system.py` の `register_user()` と `change_password()` で
最小文字数などを変更可能。

## 📝 今後の拡張案

1. **メール認証**
   - 新規登録時にメール確認
   - パスワードリセット機能

2. **ファイルアップロード管理**
   - 音源ファイル自体も保存
   - ダウンロード機能

3. **チーム機能**
   - 組織内での共有
   - チーム別統計

4. **エクスポート機能**
   - 解析結果のCSV出力
   - レポート生成

5. **API連携**
   - 外部サービスとの連携
   - 自動バックアップ

## ⚠️ 注意事項

1. **本番環境での使用**
   - より強固な認証（OAuth等）推奨
   - HTTPS必須
   - データベースを本格的なDBに移行推奨

2. **バックアップ**
   - `users.json` と `user_audio_data/` を定期的にバックアップ

3. **プライバシー**
   - ユーザーデータの取り扱いに注意
   - 利用規約・プライバシーポリシーの整備

## 🐛 トラブルシューティング

### ログインできない

1. `users.json` が存在するか確認
2. デフォルト管理者アカウントで試す
3. `users.json` を削除して再起動（管理者アカウント再作成）

### データが表示されない

1. `user_audio_data/` ディレクトリが存在するか確認
2. 該当ユーザーの `.json` ファイルが存在するか確認

### 管理者ダッシュボードが表示されない

1. ログインユーザーの `role` が `"admin"` か確認
2. `users.json` を直接編集して確認

## 📞 サポート

質問・バグ報告があれば、開発者に連絡してください。
